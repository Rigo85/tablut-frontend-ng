<div class="app-shell">
  <header class="topbar">
    <div>
      <h1>Tablut</h1>
      <p class="subtitle">Cartier Variant - Humano vs Bot</p>
    </div>
    <div class="top-actions">
      <button class="btn ghost" (click)="onNewGameClick()">Nueva partida</button>
      <button class="btn" [disabled]="loading()" (click)="openResources()">Recursos</button>
    </div>
  </header>

  <section class="status-row" *ngIf="state() as st">
    <span>Juego: <strong>{{ st.id }}</strong></span>
    <span>Humano: <strong>{{ st.humanSide }}</strong></span>
    <span>Bot: <strong>{{ st.botSide }}</strong></span>
    <span>Turno: <strong>{{ turnLabel() }}</strong></span>
    <span>Dificultad: <strong>{{ st.difficulty }}</strong></span>
  </section>

  <section class="message" *ngIf="message()">{{ message() }}</section>

  <main class="board-and-log" *ngIf="state() as st">
    <div class="board-wrap">
      <div class="board-shell">
        <div class="board-row" *ngFor="let r of rows">
          <span class="coord-cell rank">{{ 9 - r }}</span>
          <div class="row">
            <button
              type="button"
              class="cell"
              *ngFor="let c of cols; trackBy: trackByCell"
              [class.cell-edge]="isEdge(r, c)"
              [class.cell-throne]="isThrone(r, c)"
              [class.cell-attacker-start]="isAttackerStart(r, c)"
              [class.cell-king-axis]="isKingAxis(r, c)"
              [class.cell-selected]="isSelected(r, c)"
              [class.cell-target]="isTarget(r, c)"
              [disabled]="loading() || st.phase === 'GAME_OVER'"
              (click)="onCellClick(r, c)"
            >
              <span [class]="cellPieceClass(r, c)">{{ cellLabel(r, c) }}</span>
            </button>
          </div>
        </div>

        <div class="coords-bottom">
          <span class="coord-cell coord-spacer"></span>
          <span class="coord-cell file" *ngFor="let f of files">{{ f }}</span>
        </div>
      </div>
    </div>

    <aside class="log-panel">
      <h2>Bitácora</h2>
      <ol>
        <li *ngFor="let item of logs()">{{ item }}</li>
      </ol>
    </aside>
  </main>

  <div class="setup-overlay" *ngIf="setupOpen()">
    <div class="setup-card">
      <h2>Iniciar partida</h2>
      <p>Elige tu bando y dificultad del bot.</p>

      <div class="setup-block">
        <label>Bando humano</label>
        <div class="side-buttons">
          <button class="btn" [class.active]="setupHumanSide() === 'DEFENDER'" (click)="onSelectHumanSide('DEFENDER')">
            DEFENDER
          </button>
          <button class="btn" [class.active]="setupHumanSide() === 'ATTACKER'" (click)="onSelectHumanSide('ATTACKER')">
            ATTACKER
          </button>
        </div>
      </div>

      <div class="setup-block">
        <label>Dificultad</label>
        <div class="side-buttons">
          <button class="btn" [class.active]="setupDifficulty() === 2" (click)="setupDifficulty.set(2)">2</button>
          <button class="btn" [class.active]="setupDifficulty() === 4" (click)="setupDifficulty.set(4)">4</button>
        </div>
      </div>

      <div class="setup-actions">
        <button
          class="btn ghost"
          *ngIf="state()"
          [disabled]="loading() || setupSubmitting()"
          (click)="closeSetup()"
        >
          Cancelar
        </button>
        <button class="btn primary" [disabled]="loading() || setupSubmitting()" (click)="startNewGame()">
          {{ setupSubmitting() ? 'Creando partida...' : 'Comenzar' }}
        </button>
      </div>
    </div>
  </div>

  <div class="setup-overlay" *ngIf="resourcesOpen()">
    <div class="setup-card">
      <h2>Recursos</h2>
      <p>Accesos útiles de la partida.</p>

      <div class="setup-block">
        <button class="btn primary resources-btn" (click)="openHelp()">Guía del juego</button>
      </div>

      <div class="setup-block">
        <a
          class="btn ghost resources-link"
          [attr.href]="githubUrl"
          target="_blank"
          rel="noopener noreferrer"
        >
          Repositorio GitHub
        </a>
      </div>

      <button class="btn" (click)="closeResources()">Cerrar</button>
    </div>
  </div>

  <div class="setup-overlay" *ngIf="helpOpen()">
    <div class="setup-card help-card">
      <h2>Guía de juego</h2>
      <p *ngIf="helpLoading()">Cargando guía...</p>
      <p class="message" *ngIf="helpError()">{{ helpError() }}</p>
      <div class="help-content" *ngIf="!helpLoading() && !helpError()" [innerHTML]="helpHtml()"></div>
      <button class="btn" (click)="closeHelp()">Cerrar</button>
    </div>
  </div>

  <div class="loading-overlay" *ngIf="loading()">
    <div class="loading-card">
      <span class="spinner"></span>
      <p>Procesando jugada y sincronizando estado...</p>
    </div>
  </div>
</div>
